<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JaringanKu - Dashboard Inventory</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Animate.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>

  <!-- Chart.js UMD bundle (explicit to avoid sourcemap 404) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --accent: #2563eb; /* blue */
      --bg: linear-gradient(180deg,#f7f9fc,#ffffff);
      --card-bg: #ffffff;
      --glass-border: rgba(15,23,42,0.06);
      --muted: #6b7280;
      --text: #0b1220;
      --shadow: 0 12px 40px rgba(14,20,30,0.06);
      --radius: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;padding:22px;background:var(--card-bg);border-right:1px solid var(--glass-border);box-shadow:var(--shadow);transition:width .25s}
    .sidebar.collapsed{width:72px}
    .content{margin-left:260px;padding:28px;transition:margin-left .25s}
    .sidebar.collapsed + .content{margin-left:72px}
    .glass{background:var(--card-bg);border-radius:var(--radius);padding:16px;border:1px solid var(--glass-border);box-shadow:var(--shadow);transition:transform .18s}
    .glass:hover{transform:translateY(-6px)}
    .muted{color:var(--muted);font-size:.92rem}
    .brand{font-weight:700}
    .badge-logo{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--accent), #1e3a8a);font-weight:700}
    .nav-link{display:flex;gap:12px;align-items:center;padding:10px 12px;color:var(--muted);text-decoration:none;border-radius:10px;margin:8px 0;cursor:pointer;transition:all .18s}
    .nav-link i{font-size:1.08rem}
    .nav-link.active,.nav-link:hover{background:linear-gradient(90deg, rgba(37,99,235,0.06), rgba(37,99,235,0.02));color:var(--accent);transform:translateX(6px)}
    .stat-card{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .stat-value{font-size:1.4rem;font-weight:700}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .icon-btn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--muted);cursor:pointer}
    .page{display:none}
    .page.active{display:block;animation:fadeInUp .36s ease}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .center-vh{display:flex;align-items:center;justify-content:center;height:100vh;padding:12px}
    .login-box{width:420px;max-width:95%;padding:22px;border-radius:12px}
    #loadingOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.6);z-index:9999}
    table.table thead th{color:var(--muted)}
    .small-muted{font-size:.86rem;color:var(--muted)}
    @media (max-width:900px){.sidebar{position:relative;width:100%;height:auto;display:flex;gap:8px;overflow-x:auto;padding:10px}.content{margin-left:0;padding:12px}}
  </style>
</head>
<body>

  <!-- Loading overlay -->
  <div id="loadingOverlay"><div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"></div></div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="center-vh">
    <div class="glass login-box animate__animated animate__fadeInUp">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div><h4 style="margin:0">üîê Login Admin</h4><div class="small-muted">Masuk untuk mengelola inventori</div></div>
        <button id="demoFillBtn" class="icon-btn" title="Isi demo"><i class="bi bi-bug"></i></button>
      </div>
      <div class="mb-2"><label class="muted">Username</label><input id="loginUser" class="form-control" placeholder="..."></div>
      <div class="mb-3"><label class="muted">Password</label><input id="loginPass" type="password" class="form-control" placeholder="..."></div>
      <div class="d-flex gap-2">
        <button id="btnLogin" class="btn" style="background:linear-gradient(90deg,var(--accent), #1e3a8a);color:#fff">Login</button>
        <button id="btnThemeToggle" class="btn btn-outline-secondary" title="Toggle Theme"><i class="bi bi-brightness-high"></i></button>
      </div>
      <div class="muted mt-3"><strong></strong>JaringanKu Sarana Nusantara<strong></strong></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <aside id="sidebar" class="sidebar animate__animated animate__fadeInLeft">
      <div class="logo mb-3 d-flex align-items-center" style="gap:12px">
        <div class="badge-logo">J</div>
        <div>
          <div class="brand">JaringanKu</div>
          <div class="small-muted">Inventory SaaS</div>
        </div>
      </div>

      <nav id="sidebarNav" aria-label="Sidebar menu">
        <div class="nav-link" data-page="dashboardPage"><i class="bi bi-speedometer2"></i><span>Dashboard</span></div>
        <div class="nav-link" data-page="barangPage"><i class="bi bi-box-seam"></i><span>Barang</span></div>
        <div class="nav-link" data-page="stokMasukPage"><i class="bi bi-cloud-arrow-down"></i><span>Stok Masuk</span></div>
        <div class="nav-link" data-page="stokKeluarPage"><i class="bi bi-cloud-arrow-up"></i><span>Stok Keluar</span></div>
        <div class="nav-link" data-page="transaksiPage"><i class="bi bi-journal-text"></i><span>Transaksi</span></div>
        <div class="nav-link" data-page="laporanPage"><i class="bi bi-bar-chart-line"></i><span>Laporan</span></div>

        <hr style="border-color:var(--glass-border)">
        <div class="nav-link" id="toggleSidebarBtn"><i class="bi bi-layout-sidebar-inset"></i><span>Toggle Sidebar</span></div>
        <div class="nav-link" id="logoutBtn"><i class="bi bi-box-arrow-right"></i><span>Logout</span></div>
      </nav>

      <div style="position:absolute;left:20px;right:20px;bottom:20px">
        <div class="muted small-muted mb-2">Accent</div>
        <div style="display:flex;gap:8px">
          <button id="swatchBlue" class="icon-btn" style="background:linear-gradient(90deg,#2563eb,#1e3a8a);border-radius:8px"></button>
          <button id="swatchGreen" class="icon-btn" style="background:linear-gradient(90deg,#10b981,#059669);border-radius:8px"></button>
          <button id="swatchPurple" class="icon-btn" style="background:linear-gradient(90deg,#7c3aed,#5b21b6);border-radius:8px"></button>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div>
          <h3 style="margin:0">Halo, Admin üëã</h3>
          <div class="small-muted">Ringkasan Dan Pengelolaan Inventori PT.JaringanKu Sarana Nusantara</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button id="exportPdfBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
          <button id="exportExcelBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-excel"></i> Excel</button>
        </div>
      </div>

      <section id="pages">
        <!-- Dashboard -->
        <div id="dashboardPage" class="page active">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="glass stat-card">
                <div>
                  <div class="muted">Total Barang</div>
                  <div id="statTotalBarang" class="stat-value">0</div>
                </div>
                <i class="bi bi-box-seam" style="font-size:1.4rem;color:var(--accent)"></i>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass stat-card">
                <div>
                  <div class="muted">Total Kategori</div>
                  <div id="statKategori" class="stat-value">0</div>
                </div>
                <i class="bi bi-tags" style="font-size:1.4rem;color:var(--accent)"></i>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass stat-card">
                <div>
                  <div class="muted">Total Stok</div>
                  <div id="statStok" class="stat-value">0</div>
                </div>
                <i class="bi bi-stack" style="font-size:1.4rem;color:var(--accent)"></i>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-7">
              <div class="glass">
                <h6>Grafik Stok</h6>
                <canvas id="dashChart" height="140"></canvas>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="glass">
                <h6>Aktivitas Terakhir</h6>
                <ul id="recentActivity" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Barang -->
        <div id="barangPage" class="page">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h4>Manajemen Barang</h4>
              <div class="muted">Tambah / Edit / Hapus</div>
            </div>
            <div class="d-flex gap-2">
              <button id="btnImportExample" class="btn btn-outline-secondary">Isi contoh</button>
              <button id="btnAddNew" class="btn" style="background:linear-gradient(90deg,var(--accent), #1e3a8a);color:#fff">Tambah Baru</button>
            </div>
          </div>

          <div class="glass mb-3 p-3">
            <div class="row g-2 align-items-center">
              <div class="col-md-4"><input id="filterName" class="form-control" placeholder="Cari nama..."></div>
              <div class="col-md-3"><input id="filterCategory" class="form-control" placeholder="Filter kategori..."></div>
              <div class="col-md-3"><button id="btnClearFilters" class="btn btn-outline-secondary w-100">Reset Filter</button></div>
            </div>
          </div>

          <div class="glass p-0">
            <table class="table mb-0">
              <thead>
                <tr><th>Nama</th><th>Jumlah</th><th>Kategori</th><th style="width:160px">Aksi</th></tr>
              </thead>
              <tbody id="tableBarang"></tbody>
            </table>
          </div>
        </div>

        <!-- Stok Masuk -->
        <div id="stokMasukPage" class="page">
          <h4>Stok Masuk</h4>
          <div class="glass p-3 mb-3">
            <div class="row g-2">
              <div class="col-md-6"><select id="selectMasuk" class="form-select"></select></div>
              <div class="col-md-3"><input id="inputMasukJumlah" type="number" class="form-control" placeholder="Jumlah"></div>
              <div class="col-md-3"><button id="btnMasuk" class="btn btn-success w-100">Tambah Stok</button></div>
            </div>
          </div>

          <div class="glass p-0">
            <h6 class="mb-2">Riwayat Stok Masuk</h6>
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Barang</th><th>Jumlah</th></tr></thead>
              <tbody id="tableStokMasuk"></tbody>
            </table>
          </div>
        </div>

        <!-- Stok Keluar -->
        <div id="stokKeluarPage" class="page">
          <h4>Stok Keluar</h4>
          <div class="glass p-3 mb-3">
            <div class="row g-2">
              <div class="col-md-6"><select id="selectKeluar" class="form-select"></select></div>
              <div class="col-md-3"><input id="inputKeluarJumlah" type="number" class="form-control" placeholder="Jumlah"></div>
              <div class="col-md-3"><button id="btnKeluar" class="btn btn-danger w-100">Kurangi Stok</button></div>
            </div>
          </div>

          <div class="glass p-0">
            <h6 class="mb-2">Riwayat Stok Keluar</h6>
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Barang</th><th>Jumlah</th></tr></thead>
              <tbody id="tableStokKeluar"></tbody>
            </table>
          </div>
        </div>

        <!-- Transaksi -->
        <div id="transaksiPage" class="page">
          <h4>History Transaksi</h4>
          <div class="glass p-3">
            <table class="table mb-0">
              <thead><tr><th>Tanggal</th><th>Jenis</th><th>Barang</th><th>Jumlah</th><th>Aksi</th></tr></thead>
              <tbody id="tableTransaksi"></tbody>
            </table>
          </div>
        </div>

        <!-- Laporan -->
        <div id="laporanPage" class="page">
          <h4>Laporan & Visualisasi</h4>
          <div class="row g-3">
            <div class="col-md-6"><div class="glass p-3"><h6>Jumlah Stok per Barang</h6><canvas id="chartBarang" height="180"></canvas></div></div>
            <div class="col-md-6"><div class="glass p-3"><h6>Distribusi per Kategori</h6><canvas id="chartKategori" height="180"></canvas></div></div>
          </div>

          <div class="glass mt-3 p-3">
            <h6>Ringkasan Transaksi</h6>
            <div id="laporanText" class="small-muted">Belum ada data...</div>
          </div>
        </div>

      </section>
    </main>
  </div>

<script>
/* Final Light Premium Dashboard - Single HTML
   Features:
   - Login (admin/123)
   - Sidebar navigation
   - CRUD Barang
   - Stok Masuk/Keluar
   - Transaksi history
   - Laporan (Chart.js)
   - Export PDF & Excel
   - localStorage persistence
   - Animations & accents
*/

document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);

  // load state
  let dataBarang = JSON.parse(localStorage.getItem('dataBarang') || '[]');
  let dataTransaksi = JSON.parse(localStorage.getItem('dataTransaksi') || '[]');
  let chartBarangObj = null, chartKategoriObj = null, dashChartObj = null;

  // refs
  const loadingOverlay = $('loadingOverlay');
  const loginScreen = $('loginScreen');
  const app = $('app');
  const sidebarNav = document.getElementById('sidebarNav');

  // helpers
  const showLoading = v => loadingOverlay.style.display = v ? 'flex' : 'none';
  const toastSuccess = m => Swal.fire({ toast:true, position:'top-end', icon:'success', title:m, showConfirmButton:false, timer:1100 });
  const toastError = m => Swal.fire({ toast:true, position:'top-end', icon:'error', title:m, showConfirmButton:false, timer:1400 });
  const saveAll = () => { localStorage.setItem('dataBarang', JSON.stringify(dataBarang)); localStorage.setItem('dataTransaksi', JSON.stringify(dataTransaksi)); };

  // safe navigate function: toggles .active on pages
  function navigateTo(pageId){
    // deactivate pages
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if(!page){ console.warn('navigateTo: page not found', pageId); return; }
    page.classList.add('active');

    // small delay for animation then run page-specific render
    setTimeout(()=>{
      if(pageId === 'barangPage') renderTableBarang();
      if(pageId === 'stokMasukPage' || pageId === 'stokKeluarPage') refreshSelectOptions();
      if(pageId === 'transaksiPage') renderTransaksi();
      if(pageId === 'laporanPage') renderLaporan();
      if(pageId === 'dashboardPage') renderDashboard();
    }, 50);
  }

  // fallback showPage
  window.showPage = function(id){
    document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
    const nav = document.querySelector(`.nav-link[data-page="${id}"]`);
    if(nav) nav.classList.add('active');
    navigateTo(id);
  };

  // LOGIN
  $('btnLogin').addEventListener('click', ()=>{
    const u = $('loginUser').value.trim(), p = $('loginPass').value;
    if(u === 'admin' && p === 'jsnkarmijah'){
      showLoading(true);
      setTimeout(()=>{ showLoading(false); loginScreen.style.display = 'none'; app.style.display = 'block';
        // set active nav
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
        const firstNav = document.querySelector('.nav-link[data-page="dashboardPage"]'); if(firstNav) firstNav.classList.add('active');
        navigateTo('dashboardPage'); renderAllOnStart(); toastSuccess('Login berhasil'); }, 450);
    } else Swal.fire('Gagal','Username / password salah','error');
  });

  // demo fill & theme toggle
  $('demoFillBtn').addEventListener('click', ()=>{ $('loginUser').value='admin'; $('loginPass').value='jsnkarmijah'; });
  $('btnThemeToggle').addEventListener('click', ()=> document.body.classList.toggle('light'));

  // sidebar click (delegation)
  if(sidebarNav){
    sidebarNav.addEventListener('click', (e)=>{
      const item = e.target.closest('.nav-link');
      if(!item) return;
      const page = item.getAttribute('data-page');
      // handle special buttons (toggle, logout)
      if(!page){
        if(item.id === 'toggleSidebarBtn'){ document.querySelector('.sidebar')?.classList.toggle('collapsed'); document.querySelector('.content')?.classList.toggle('collapsed'); }
        if(item.id === 'logoutBtn'){ Swal.fire({ title:'Keluar?', showCancelButton:true }).then(r=>{ if(r.isConfirmed) location.reload(); }); }
        return;
      }
      // set active nav-item
      document.querySelectorAll('.nav-link[data-page]').forEach(n=>n.classList.remove('active'));
      item.classList.add('active');
      navigateTo(page);
    });
  }

  // accent swatches
  function setAccent(c){ document.documentElement.style.setProperty('--accent', c); localStorage.setItem('accent', c); toastSuccess('Accent diubah'); }
  $('swatchBlue').addEventListener('click', ()=> setAccent('#2563eb'));
  $('swatchGreen').addEventListener('click', ()=> setAccent('#10b981'));
  $('swatchPurple').addEventListener('click', ()=> setAccent('#7c3aed'));
  const savedAccent = localStorage.getItem('accent'); if(savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);

  // ---------- CRUD Barang ----------
  $('btnAddNew').addEventListener('click', ()=> openAddEditModal());
  $('btnImportExample').addEventListener('click', ()=> {
    dataBarang = [
      { nama:'Mouse Wireless', jumlah:25, kategori:'Elektronik' },
      { nama:'Buku Catatan', jumlah:120, kategori:'Alat Tulis' },
      { nama:'Kabel USB-C', jumlah:60, kategori:'Elektronik' },
      { nama:'Pulpen', jumlah:200, kategori:'Alat Tulis' }
    ];
    saveAll(); renderTableBarang(); renderLaporan(); renderDashboard(); toastSuccess('Contoh dimuat');
  });

  function openAddEditModal(editIndex=null){
    Swal.fire({
      title: editIndex === null ? 'Tambah Barang' : 'Edit Barang',
      html:`<input id="swal-name" class="swal2-input" placeholder="Nama">
            <input id="swal-jumlah" type="number" class="swal2-input" placeholder="Jumlah">
            <input id="swal-kategori" class="swal2-input" placeholder="Kategori">`,
      focusConfirm:false,
      preConfirm: ()=>{
        const n = document.getElementById('swal-name').value.trim();
        const j = parseInt(document.getElementById('swal-jumlah').value);
        const k = document.getElementById('swal-kategori').value.trim();
        if(!n || isNaN(j) || j < 0 || !k){ Swal.showValidationMessage('Lengkapi field valid'); return false; }
        return { n,j,k };
      }
    }).then(res=>{
      if(res.isConfirmed && res.value){
        const { n,j,k } = res.value;
        if(editIndex === null){ dataBarang.push({ nama:n, jumlah:j, kategori:k }); toastSuccess('Barang ditambahkan'); }
        else { dataBarang[editIndex] = { nama:n, jumlah:j, kategori:k }; toastSuccess('Barang diperbarui'); }
        saveAll(); renderTableBarang(); renderLaporan(); renderDashboard();
      }
    });
  }

  function renderTableBarang(){
    const tbody = $('tableBarang'); if(!tbody) return;
    tbody.innerHTML = '';
    const q = ($('filterName')?.value || '').toLowerCase();
    const cat = ($('filterCategory')?.value || '').toLowerCase();
    let filtered = dataBarang.slice();
    if(q) filtered = filtered.filter(b => b.nama.toLowerCase().includes(q));
    if(cat) filtered = filtered.filter(b => b.kategori.toLowerCase().includes(cat));
    filtered.forEach(b=>{
      const idx = dataBarang.indexOf(b);
      const tr = document.createElement('tr'); tr.className='animate__animated animate__fadeIn';
      tr.innerHTML = `<td>${b.nama}</td><td>${b.jumlah}</td><td>${b.kategori}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-1" data-edit="${idx}"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-delete="${idx}"><i class="bi bi-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });

    // attach actions
    tbody.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', ()=> openAddEditModal(parseInt(btn.getAttribute('data-edit')))));
    tbody.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', ()=> deleteBarang(parseInt(btn.getAttribute('data-delete')))));

    renderDashboard();
  }

  function deleteBarang(i){
    Swal.fire({ title:'Hapus?', text:'Data akan dihapus permanen', icon:'warning', showCancelButton:true }).then(r=>{
      if(r.isConfirmed){ dataBarang.splice(i,1); saveAll(); renderTableBarang(); renderLaporan(); renderDashboard(); toastSuccess('Barang dihapus'); }
    });
  }

  // ---------- Stok masuk/keluar ----------
  function refreshSelectOptions(){
    const selM = $('selectMasuk'), selK = $('selectKeluar');
    if(!selM || !selK) return;
    selM.innerHTML = selK.innerHTML = '';
    dataBarang.forEach((b,i)=> {
      const opt = `<option value="${i}">${b.nama} ‚Äî (${b.jumlah})</option>`;
      selM.insertAdjacentHTML('beforeend', opt);
      selK.insertAdjacentHTML('beforeend', opt);
    });
  }

  $('btnMasuk').addEventListener('click', ()=>{
    const i = parseInt($('selectMasuk').value), j = parseInt($('inputMasukJumlah').value);
    if(isNaN(i) || isNaN(j) || j<=0){ toastError('Jumlah tidak valid'); return; }
    dataBarang[i].jumlah += j;
    dataTransaksi.unshift({ tanggal:new Date().toLocaleString(), jenis:'Masuk', barang:dataBarang[i].nama, jumlah:j });
    saveAll(); renderTableBarang(); renderTransaksi(); renderLaporan(); renderDashboard(); $('inputMasukJumlah').value=''; toastSuccess('Stok masuk dicatat');
  });

  $('btnKeluar').addEventListener('click', ()=>{
    const i = parseInt($('selectKeluar').value), j = parseInt($('inputKeluarJumlah').value);
    if(isNaN(i) || isNaN(j) || j<=0){ toastError('Jumlah tidak valid'); return; }
    if(dataBarang[i].jumlah < j){ toastError('Stok tidak cukup'); return; }
    dataBarang[i].jumlah -= j;
    dataTransaksi.unshift({ tanggal:new Date().toLocaleString(), jenis:'Keluar', barang:dataBarang[i].nama, jumlah:j });
    saveAll(); renderTableBarang(); renderTransaksi(); renderLaporan(); renderDashboard(); $('inputKeluarJumlah').value=''; toastSuccess('Stok keluar dicatat');
  });

  // ---------- Transaksi ----------
  function renderTransaksi(){
    const tb = $('tableTransaksi'); if(!tb) return;
    tb.innerHTML = '';
    dataTransaksi.forEach((t, idx)=>{
      const tr = document.createElement('tr'); tr.className='animate__animated animate__fadeIn';
      tr.innerHTML = `<td>${t.tanggal}</td><td>${t.jenis}</td><td>${t.barang}</td><td>${t.jumlah}</td>
        <td><button class="btn btn-sm btn-outline-danger" data-del="${idx}"><i class="bi bi-trash"></i></button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.getAttribute('data-del'));
      Swal.fire({ title:'Hapus transaksi?', showCancelButton:true }).then(r=>{ if(r.isConfirmed){ dataTransaksi.splice(idx,1); saveAll(); renderTransaksi(); toastSuccess('Transaksi dihapus'); }});
    }));

    // also fill stok masuk & keluar small tables
    const tbMasuk = $('tableStokMasuk'); const tbKeluar = $('tableStokKeluar');
    if(tbMasuk) tbMasuk.innerHTML = dataTransaksi.filter(t=>t.jenis==='Masuk').map(t => `<tr><td>${t.tanggal}</td><td>${t.barang}</td><td>${t.jumlah}</td></tr>`).join('') || '<tr><td colspan="3" class="small-muted">Belum ada</td></tr>';
    if(tbKeluar) tbKeluar.innerHTML = dataTransaksi.filter(t=>t.jenis==='Keluar').map(t => `<tr><td>${t.tanggal}</td><td>${t.barang}</td><td>${t.jumlah}</td></tr>`).join('') || '<tr><td colspan="3" class="small-muted">Belum ada</td></tr>';
  }

  // ---------- Laporan & Charts ----------
  function renderLaporan(){
    if(dataBarang.length === 0){ $('laporanText').textContent = 'Belum ada data barang'; } else {
      let s='=== LAPORAN STOK ===\n'; dataBarang.forEach(b=> s += `${b.nama} | Jumlah: ${b.jumlah} | Kategori: ${b.kategori}\n`);
      $('laporanText').textContent = s;
    }

    const labels = dataBarang.map(b=>b.nama);
    const dataVals = dataBarang.map(b=>b.jumlah);
    const map = {}; dataBarang.forEach(b=> map[b.kategori] = (map[b.kategori]||0) + b.jumlah);
    const catLabels = Object.keys(map), catData = Object.values(map);

    if(chartBarangObj) chartBarangObj.destroy();
    if(chartKategoriObj) chartKategoriObj.destroy();

    const ctx1 = $('chartBarang')?.getContext('2d');
    if(ctx1){
      chartBarangObj = new Chart(ctx1, { type:'bar', data:{ labels, datasets:[{ label:'Jumlah Stok', data:dataVals, backgroundColor: labels.map(()=> getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#2563eb') }] }, options:{ responsive:true, plugins:{legend:{display:false}}, animation:{duration:800}, scales:{ y:{ beginAtZero:true } } } });
    }

    const ctx2 = $('chartKategori')?.getContext('2d');
    if(ctx2){
      chartKategoriObj = new Chart(ctx2, { type:'pie', data:{ labels:catLabels, datasets:[{ data:catData, backgroundColor:['#2563eb','#10b981','#7c3aed','#f59e0b','#ef4444'] }] }, options:{ responsive:true, plugins:{legend:{position:'bottom'}} } });
    }
  }

  // ---------- Dashboard render ----------
  function renderDashboard(){
    $('statTotalBarang').textContent = dataBarang.length;
    $('statKategori').textContent = (new Set(dataBarang.map(b=>b.kategori))).size;
    $('statStok').textContent = dataBarang.reduce((s,b)=>s+b.jumlah,0);

    const recent = $('recentActivity'); if(recent){ recent.innerHTML=''; dataTransaksi.slice(0,6).forEach(t=>{ const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML = `<div><strong>${t.jenis}</strong> ‚Äî ${t.barang}<div class="small-muted">${t.tanggal}</div></div><div class="badge bg-light text-dark">${t.jumlah}</div>`; recent.appendChild(li); }); }

    if(dashChartObj) dashChartObj.destroy();
    const ctx = $('dashChart')?.getContext('2d');
    if(ctx){
      dashChartObj = new Chart(ctx, { type:'line', data:{ labels: dataBarang.map(b=>b.nama), datasets:[{ label:'Stok', data: dataBarang.map(b=>b.jumlah), fill:true, backgroundColor:'rgba(37,99,235,0.12)', borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#2563eb', tension:0.35 }] }, options:{ responsive:true, plugins:{legend:{display:false}}, animation:{duration:700} } });
    }
  }

  // ---------- Export ----------
  $('exportPdfBtn').addEventListener('click', ()=>{
    if(dataBarang.length === 0){ toastError('Tidak ada data untuk diexport'); return; }
    const { jsPDF } = window.jspdf; const doc = new jsPDF('p','pt','a4'); doc.setFontSize(14); doc.text('LAPORAN STOK - BarangKu',40,40);
    const rows = dataBarang.map(b=>[b.nama,b.jumlah.toString(),b.kategori]); doc.autoTable({ head:[['Nama','Jumlah','Kategori']], body:rows, startY:70 }); doc.save('laporan_stok.pdf'); toastSuccess('PDF diunduh');
  });

  $('exportExcelBtn').addEventListener('click', ()=>{
    if(dataBarang.length === 0){ toastError('Tidak ada data'); return; }
    const wb = XLSX.utils.book_new(); const wsData = [['Nama','Jumlah','Kategori'], ...dataBarang.map(b=>[b.nama,b.jumlah,b.kategori])];
    const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, 'Laporan'); XLSX.writeFile(wb, 'laporan_stok.xlsx'); toastSuccess('Excel diunduh');
  });

  // ---------- Init & helpers ----------
  function renderAllOnStart(){ renderTableBarang(); renderTransaksi(); renderLaporan(); renderDashboard(); refreshSelectOptions(); }
  renderAllOnStart();

  // filters
  $('filterName')?.addEventListener('input', ()=> renderTableBarang());
  $('filterCategory')?.addEventListener('input', ()=> renderTableBarang());
  $('btnClearFilters')?.addEventListener('click', ()=> { if($('filterName')) $('filterName').value=''; if($('filterCategory')) $('filterCategory').value=''; renderTableBarang(); });

}); // DOMContentLoaded end
</script>
</body>
</html>
